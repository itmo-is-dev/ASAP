@using ITMO.Dev.ASAP.WebUI.AdminPanel.ExceptionHandling
@using ITMO.Dev.ASAP.WebUI.AdminPanel.Extensions
@using ITMO.Dev.ASAP.WebUI.AdminPanel.Authorization
@implements IDisposable
@inject ISafeExecutor Executor
@inject NavigationManager NavigationManager
@inject ICurrentUser CurrentUser

<Bar Breakpoint="Breakpoint.Desktop"
     Background="Background.Light"
     ThemeContrast="ThemeContrast.Light">

    <BarBrand>
        <Anchor To="/" TextColor="TextColor.Dark">
            ASAP
        </Anchor>
    </BarBrand>

    <BarToggler/>

    <BarMenu>
        <BarStart>
            @if (CurrentUser.HasModeratorAccess())
            {
                <BarItem>
                    <BarLink @ref="_globalLink" To="@GlobalPath">Global</BarLink>
                </BarItem>
            }

            <BarItem>
                <BarLink @ref="_subjectsLink" To="@SubjectsPath">Subjects</BarLink>
            </BarItem>

            @if (CurrentUser.HasModeratorAccess())
            {
                <BarItem>
                    <BarLink @ref="_studentsLink" To="@StudentsPath">Students</BarLink>
                </BarItem>
            }

            @if (CurrentUser.HasModeratorAccess())
            {
                <BarItem>
                    <BarLink @ref="_groupsLink" To="@GroupsPath">Groups</BarLink>
                </BarItem>
            }

            @if (CurrentUser.HasModeratorAccess())
            {
                <BarItem>
                    <BarLink @ref="_usersLink" To="@UsersPath">Users</BarLink>
                </BarItem>
            }
        </BarStart>

        <BarEnd>
            <BarItem>
                <BarLink To="logout">Logout</BarLink>
            </BarItem>
        </BarEnd>
    </BarMenu>
</Bar>

@code {

        private const string GlobalPath = "adminpanel/global";
        private const string SubjectsPath = "adminpanel/subjects";
        private const string StudentsPath = "adminpanel/students";
        private const string GroupsPath = "adminpanel/groups";
        private const string UsersPath = "adminpanel/users";

    private BarLink? _globalLink;
    private BarLink? _subjectsLink;
    private BarLink? _studentsLink;
    private BarLink? _groupsLink;
    private BarLink? _usersLink;

    protected override Task OnInitializedAsync()
    {
        NavigationManager.LocationChanged += HandleLocationChanged;
        return Task.CompletedTask;
    }

    public void Dispose()
    {
        NavigationManager.LocationChanged -= HandleLocationChanged;
    }

    private void HandleLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        var uri = new Uri(NavigationManager.Uri);

        BaseComponent? component = uri.AbsolutePath switch
        {
            GlobalPath => _globalLink,
            SubjectsPath => _subjectsLink,
            StudentsPath => _studentsLink,
            GroupsPath => _groupsLink,
            UsersPath => _usersLink,
            _ => null,
            };

        if (component is not null)
            Activate(component);
    }

    private void Activate(BaseComponent component)
    {
        component.Class = $"active {component.Class}";
    }

}